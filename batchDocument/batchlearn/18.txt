18、延迟环境变量扩展

    我们知道CMD在解释命令时,首先会把一条完整的命令进行读取,然后进行匹配操作,匹配时他会把命令里的变量用变量的值替换掉,然后执行这个替换好的命令.

    延迟变量全称"延迟环境变量扩展",要理解这个东西,我们还得先理解一下什么叫扩展!CMD在解释我们的命令的时候,首先会读取命令行一条完整的命令,然后对其进行一些命令格式的匹配操作,看你所输入的命令格式是不是符合他的要求.

　　如果我们要在我们的命令中引用一些变量,那么我们如何让CMD在解释我们的命令时,能识别出这个变量呢?这时我们就可以在变量名字两边加一个%号,如%name%.当CMD在对读取我们的整行命令进行格式匹配的时候,就会发现name这个字符两边加了%号,就不会把他当作普通字符处理,而是会把他当作一个变量处理,变量名叫name.然后CMD就会找到变量名对应的值,用变量名的值替换掉这个变量名字(name),(如果变量名不存在值,就返回空值).再将这个替换好并且匹配的命令执行!这个替换值的过程,就叫做变量扩展,说白了就是把变量的名字,用他的值给替换掉后执行!也就是批处理如何识别一个变量的过程.这就是变量扩展.

cmd执行bat的机制：cmd是读一句执行一句，何谓一句？

　　一般的一行，for, if的整句，&、&&、|| 等由连接符连接的整行，()圆扩符之间的代码...都叫一句。cmd读一句后先不会执行，而会预处理该句子，所谓预处理就是为执行作一下准备工作，检查代码是否合法，替换%%包含的变量，特殊符号的处理等。此时,如果我们如果在括号里面嵌入一些设置变量值的命令,就会出现问题了!

我们可以用setlocal ENABLEDELAYEDEXPANSION这个命令来启用"延迟环境变量扩展"

启用了"延迟环境变量扩展"后,当CMD在解释涵有嵌套格式的命令时,他会把嵌套的命令一条一条的先执行一次,然后再进行匹配操作,这样我们的赋值操作就会完成.并且在"延迟环境变量扩展"启用后,CMD会用!号来判断这是不是一个变量,没启用则用%name%这样的格式判断,启用后就用!name!格式判断了,这个符号我们需要注意!
【注意】在for执行语句中只要不是for自身变量%%i，其他任何出现的%都应该替换为!  (即使不是变量，例如 set str=!s:a=s!)